<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <base href="%PUBLIC_URL%/">
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="A few clicks away to safely transfer money."
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <title>Bevel Plexus</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root">
      <!-- <div id="vouched-element" style='height: 100%;'></div> -->
    </div>

    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>
    <script src="https://static.vouched.id/widget/vouched-2.0.0.js"></script>
    <script type="text/javascript">
      (function () {
        let userdetails = JSON.parse(localStorage.getItem('user'));
        let userID = userdetails.id;
        let token = localStorage.getItem('token');
        var vouched = Vouched({
          appId: 'nuIbrjutl~#lpmpfGC1F8~cc~YjyKX',
          crossDevice: true,
          crossDeviceQRCode: false,
          callbackURL: `https://bp-user.herokuapp.com/verify/response/${userID}`,
          onSubmit: ({stage, attempts, job}) => {
            console.log('submit', {stage, attempts, job});
          },
          onCamera: ({hasCamera, hasPermission}) => {
            console.log('onCamera', {hasCamera, hasPermission});
          },
          onInit: ({token}) => {
            // if crossDevice is true, a web token is created during initialization for
            // session handoffs to other devices
            console.log('initialization');
          },
          onDone: (job) => {
            // token used to query jobs
            console.log('Scanning complete', {token: job.token});
            let content = {
              query: `{
                getUserKyc(userId: "${userID}") {
                  id
                  userId
                  status
                  jobId
                  result
                  isVerified
                  }
                }
              `,
            };
            let body = JSON.stringify(content);
            fetch('https://bp-user.herokuapp.com/graphql', {
              method: 'post',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
              },
              body: body,
            })
              .then((response) => response.json())
              .then((data) => {
                console.log(data);
                if(data.errors){
                 alert(data.errors[0].message)
                }
                setTimeout(function () {
                  if ((userdetails.userType == 'Student')) {
                    if (data.data.getUserKyc.isVerified) {
                      localStorage.setItem('tempEnrollmentVerified', true)
                      localStorage.setItem('VerifyIdentity', 'success');
                      window.location.href = '/register-step-four';
                    } else {
                      localStorage.setItem('VerifyIdentity', 'failed');
                      window.location.href = '/register-step-four';
                    }
                  } else {
                    if (data.data.getUserKyc.isVerified) {
                      localStorage.setItem('tempEnrollmentVerified', true)
                      localStorage.setItem('VerifyIdentity', 'success');
                      window.location.href = '/register-step-four-regular';
                    } else {
                      localStorage.setItem('VerifyIdentity', 'failed');
                      window.location.href = '/register-step-four-regular';
                    }
                  }
                }, 4000);
              });

            // query the job with the token
            fetch(`/yourapi/idv?job_token=${job.token}`);
          },
          stepTitles: {
            FrontId: 'Upload ID',
            Face: 'Upload Headshot',
            Done: 'Finished',
          },
          content: {
            cameraButton: 'Take a Photo',
            crossDeviceTitle: 'Identity Verification',
            crossDeviceInstructions:
              'We need to verify your identity. This requires government-issued photo ID as well as selfie. Please follow the instructions below to continue the verification process on your phone',
            crossDeviceSuccess:
              'Verification is complete, continue on your desktop',
            review: 'Verification complete',
            upperSuccess: 'Your photo uploads are complete!',
            success: 'Please close this window to return your online visit.',
            lowerSuccess: 'Thank you.',
            upperIdInstructions:
              'Before you start please have an approved Government ID (e.g. Passport / Driving License) in your hand.',
            lowerIdInstructions: 'Please take a photo of your ID now',
            upperFaceInstructions: 'Time to take a photo.',
            lowerFaceInstructions:
              'Please take a clear picture of your face, and make sure it does not include:',
            upperFailure: 'Try Again',
            verifyFail: 'Sorry for the inconvenience',
            lowerFailure:
              "The photo you shared can't be used for validation. Please take another picture, making sure the image of your face or your ID is clear.",
          },
          theme: {
            name: 'verbose',
            font: 'Open Sans',
            fontColor: '#015eff',
            iconLabelColor: '#015eff',
            bgColor: '#FFF',
            baseColor: '#015eff',
            navigationDisabledBackground: '#015eff6b',
            navigationDisabledText: '#a3d7ee',
            navigationActiveText: '#015eff',
            iconColor: '#f6f5f3',
            iconBackground: '#62ACDE',
          },
        });
        vouched.mount('#vouched-element');
      })();
      // const GetUserProgess = () => {

      // };
    </script>
  </body>
</html>
